"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

const Handlebars = require('handlebars');

const fs = require('fs-extra');

const _ = require('lodash');

const path = require('path');

const moment = require('moment');

const base64Img = require('base64-img');

const open = require('open');

const logger = require('@log4js-node/log4js-api');

const momentDurationFormatSetup = require("moment-duration-format");

momentDurationFormatSetup(moment);

class HtmlGenerator {
  static htmlOutput(reportOptions, callback = () => {}) {
    try {
      if (reportOptions.LOG) {
        reportOptions.LOG.debug("Html Generation started");
      }

      let templateFile = fs.readFileSync(reportOptions.templateFilename, 'utf8');
      Handlebars.registerHelper('imageAsBase64', function (screenshotFile, screenshotPath, hbopts) {
        // occurs when there is an error file
        if (!fs.existsSync(screenshotFile)) {
          if (screenshotPath) {
            screenshotFile = `${screenshotPath}/${screenshotFile}`;
          } else {
            screenshotFile = `${screenshotFile}`;
          }
        }

        const data = base64Img.base64Sync(path.resolve(`${screenshotFile}`));
        return `${data}`;
      });
      Handlebars.registerHelper('isValidSuite', function (suite, hbopts) {
        if (suite.title.length > 0 && suite.type === 'suite' && suite.tests.length > 0) {
          return hbopts.fn(this);
        }
      });
      Handlebars.registerHelper('testStateColour', function (state, hbopts) {
        if (state === 'passed') {
          return 'test-pass';
        } else if (state === 'failed') {
          return 'test-fail';
        } else if (state === 'pending') {
          return 'test-pending';
        } else if (state === 'skipped') {
          return 'test-skipped';
        }
      });
      Handlebars.registerHelper('testStateIcon', function (state, hbopts) {
        if (state === 'passed') {
          return '<span class="success">&#10004;</span>';
        } else if (state === 'failed') {
          return '<span class="error">&#10006;</span>';
        } else if (state === 'pending') {
          return '<span class="pending">&#10004;</span>';
        } else if (state === 'skipped') {
          return '<span class="skipped">&#10034;</span>';
        }
      });
      Handlebars.registerHelper('suiteStateColour', function (tests, hbopts) {
        let numTests = Object.keys(tests).length;

        let fail = _.values(tests).find(test => {
          return test.state === 'failed';
        });

        if (fail != null) {
          return 'suite-fail';
        }

        let passes = _.values(tests).filter(test => {
          return test.state === 'passed';
        });

        if (passes.length === numTests && numTests > 0) {
          return 'suite-pass';
        } //skipped is the lowest priority check


        let skipped = _.values(tests).find(test => {
          return test.state === 'skipped';
        });

        if (skipped != null) {
          return 'suite-pending';
        }

        return 'suite-unknown';
      });
      Handlebars.registerHelper('humanizeDuration', function (duration, hbopts) {
        return moment.duration(duration, "milliseconds").format('hh:mm:ss.SS', {
          trim: false
        });
      });
      Handlebars.registerHelper('ifSuiteHasTests', function (testsHash, hbopts) {
        if (Object.keys(testsHash).length > 0) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifEventIsError', function (event, hbopts) {
        if (event.type.includes('Error')) {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifEventIsScreenshot', function (event, hbopts) {
        if (event.type === 'screenshot') {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('ifEventIsLogMessage', function (event, hbopts) {
        if (event.type === 'log') {
          return hbopts.fn(this);
        }

        return hbopts.inverse(this);
      });
      Handlebars.registerHelper('logClass', function (text, hbopts) {
        if (text.includes('Test Iteration')) {
          return "test-iteration";
        } else {
          return "log-output";
        }
      });
      Object.keys(reportOptions.templateFuncs).forEach(key => {
        Handlebars.registerHelper(key, reportOptions.templateFuncs[key]);
      });

      if (fs.pathExistsSync(reportOptions.outputDir)) {
        let jsonFile = reportOptions.reportFile.replace('.html', '.json');
        fs.outputFileSync(jsonFile, JSON.stringify(reportOptions.data));
      }

      let template = Handlebars.compile(templateFile);
      let html = template(reportOptions.data);

      if (fs.pathExistsSync(reportOptions.outputDir)) {
        fs.outputFileSync(reportOptions.reportFile, html);

        try {
          if (reportOptions.showInBrowser) {
            let childProcess = open(reportOptions.reportFile);
            childProcess.then(() => {
              console.log('browser launched');
            }, error => {
              console.error('showInBrowser error spawning :' + reportOptions.reportFile + " " + error.toString());
            });
          }
        } catch (ex) {
          console.error('Error opening browser:' + ex);
        }
      }

      if (reportOptions.LOG) {
        reportOptions.LOG.debug("Html Generation completed");
      }

      callback(true);
    } catch (ex) {
      if (reportOptions.LOG) {
        reportOptions.LOG.error("Html Generation processing ended in error: " + ex);
      }

      callback(false);
    }
  }

}

var _default = HtmlGenerator;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9odG1sR2VuZXJhdG9yLmpzIl0sIm5hbWVzIjpbIkhhbmRsZWJhcnMiLCJyZXF1aXJlIiwiZnMiLCJfIiwicGF0aCIsIm1vbWVudCIsImJhc2U2NEltZyIsIm9wZW4iLCJsb2dnZXIiLCJtb21lbnREdXJhdGlvbkZvcm1hdFNldHVwIiwiSHRtbEdlbmVyYXRvciIsImh0bWxPdXRwdXQiLCJyZXBvcnRPcHRpb25zIiwiY2FsbGJhY2siLCJMT0ciLCJkZWJ1ZyIsInRlbXBsYXRlRmlsZSIsInJlYWRGaWxlU3luYyIsInRlbXBsYXRlRmlsZW5hbWUiLCJyZWdpc3RlckhlbHBlciIsInNjcmVlbnNob3RGaWxlIiwic2NyZWVuc2hvdFBhdGgiLCJoYm9wdHMiLCJleGlzdHNTeW5jIiwiZGF0YSIsImJhc2U2NFN5bmMiLCJyZXNvbHZlIiwic3VpdGUiLCJ0aXRsZSIsImxlbmd0aCIsInR5cGUiLCJ0ZXN0cyIsImZuIiwic3RhdGUiLCJudW1UZXN0cyIsIk9iamVjdCIsImtleXMiLCJmYWlsIiwidmFsdWVzIiwiZmluZCIsInRlc3QiLCJwYXNzZXMiLCJmaWx0ZXIiLCJza2lwcGVkIiwiZHVyYXRpb24iLCJmb3JtYXQiLCJ0cmltIiwidGVzdHNIYXNoIiwiaW52ZXJzZSIsImV2ZW50IiwiaW5jbHVkZXMiLCJ0ZXh0IiwidGVtcGxhdGVGdW5jcyIsImZvckVhY2giLCJrZXkiLCJwYXRoRXhpc3RzU3luYyIsIm91dHB1dERpciIsImpzb25GaWxlIiwicmVwb3J0RmlsZSIsInJlcGxhY2UiLCJvdXRwdXRGaWxlU3luYyIsIkpTT04iLCJzdHJpbmdpZnkiLCJ0ZW1wbGF0ZSIsImNvbXBpbGUiLCJodG1sIiwic2hvd0luQnJvd3NlciIsImNoaWxkUHJvY2VzcyIsInRoZW4iLCJjb25zb2xlIiwibG9nIiwiZXJyb3IiLCJ0b1N0cmluZyIsImV4Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7QUFDQSxNQUFNQSxVQUFVLEdBQUdDLE9BQU8sQ0FBQyxZQUFELENBQTFC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QyxJQUFELENBQVI7QUFDSCxLQTFKRCxDQTBKRSxPQUFNNEQsRUFBTixFQUFVO0FBQ1IsVUFBSTdELGFBQWEsQ0FBQ0UsR0FBbEIsRUFBdUI7QUFDbkJGLFFBQUFBLGFBQWEsQ0FBQ0UsR0FBZCxDQUFrQnlELEtBQWxCLENBQXdCLGdEQUFnREUsRUFBeEU7QUFDSDs7QUFDRDVELE1BQUFBLFFBQVEsQ0FBQyxLQUFELENBQVI7QUFDSDtBQUNKOztBQW5LZ0I7O2VBc0tOSCxhIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmNvbnN0IEhhbmRsZWJhcnMgPSByZXF1aXJlKCdoYW5kbGViYXJzJyk7XHJcbmNvbnN0IGZzID0gcmVxdWlyZSgnZnMtZXh0cmEnKTtcclxuY29uc3QgXyA9IHJlcXVpcmUoJ2xvZGFzaCcpO1xyXG5jb25zdCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xyXG5jb25zdCBtb21lbnQgPSByZXF1aXJlKCdtb21lbnQnKTtcclxuY29uc3QgYmFzZTY0SW1nID0gcmVxdWlyZSgnYmFzZTY0LWltZycpO1xyXG5jb25zdCBvcGVuID0gcmVxdWlyZSgnb3BlbicpO1xyXG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKCdAbG9nNGpzLW5vZGUvbG9nNGpzLWFwaScpO1xyXG5cclxuY29uc3QgbW9tZW50RHVyYXRpb25Gb3JtYXRTZXR1cCA9IHJlcXVpcmUoXCJtb21lbnQtZHVyYXRpb24tZm9ybWF0XCIpO1xyXG5tb21lbnREdXJhdGlvbkZvcm1hdFNldHVwKG1vbWVudCk7XHJcblxyXG5jbGFzcyBIdG1sR2VuZXJhdG9yICB7XHJcblxyXG4gICAgc3RhdGljIGh0bWxPdXRwdXQocmVwb3J0T3B0aW9ucywgY2FsbGJhY2sgPSAoKSA9Pnt9KSB7XHJcbiAgICAgICAgdHJ5IHtcclxuICAgICAgICAgICAgaWYgKHJlcG9ydE9wdGlvbnMuTE9HKSB7XHJcbiAgICAgICAgICAgICAgICByZXBvcnRPcHRpb25zLkxPRy5kZWJ1ZyhcIkh0bWwgR2VuZXJhdGlvbiBzdGFydGVkXCIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGxldCB0ZW1wbGF0ZUZpbGUgPSBmcy5yZWFkRmlsZVN5bmMocmVwb3J0T3B0aW9ucy50ZW1wbGF0ZUZpbGVuYW1lLCAndXRmOCcpO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaW1hZ2VBc0Jhc2U2NCcsIGZ1bmN0aW9uIChzY3JlZW5zaG90RmlsZSwgc2NyZWVuc2hvdFBhdGgsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgLy8gb2NjdXJzIHdoZW4gdGhlcmUgaXMgYW4gZXJyb3IgZmlsZVxyXG4gICAgICAgICAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKHNjcmVlbnNob3RGaWxlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChzY3JlZW5zaG90UGF0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzY3JlZW5zaG90RmlsZSA9IGAke3NjcmVlbnNob3RQYXRofS8ke3NjcmVlbnNob3RGaWxlfWBcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBzY3JlZW5zaG90RmlsZSA9IGAke3NjcmVlbnNob3RGaWxlfWBcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gYmFzZTY0SW1nLmJhc2U2NFN5bmMocGF0aC5yZXNvbHZlKGAke3NjcmVlbnNob3RGaWxlfWApKTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBgJHtkYXRhfWA7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaXNWYWxpZFN1aXRlJywgZnVuY3Rpb24gKHN1aXRlLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChzdWl0ZS50aXRsZS5sZW5ndGggPiAwICYmXHJcbiAgICAgICAgICAgICAgICAgICAgc3VpdGUudHlwZSA9PT0gJ3N1aXRlJyAmJlxyXG4gICAgICAgICAgICAgICAgICAgIHN1aXRlLnRlc3RzLmxlbmd0aCA+IDAgKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5mbih0aGlzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd0ZXN0U3RhdGVDb2xvdXInLCBmdW5jdGlvbiAoc3RhdGUsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgaWYgKHN0YXRlID09PSAncGFzc2VkJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAndGVzdC1wYXNzJztcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09ICdmYWlsZWQnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd0ZXN0LWZhaWwnO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gJ3BlbmRpbmcnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd0ZXN0LXBlbmRpbmcnO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gJ3NraXBwZWQnKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJ3Rlc3Qtc2tpcHBlZCc7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCd0ZXN0U3RhdGVJY29uJywgZnVuY3Rpb24gKHN0YXRlLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChzdGF0ZSA9PT0gJ3Bhc3NlZCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxzcGFuIGNsYXNzPVwic3VjY2Vzc1wiPiYjMTAwMDQ7PC9zcGFuPicgO1xyXG4gICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0ZSA9PT0gJ2ZhaWxlZCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxzcGFuIGNsYXNzPVwiZXJyb3JcIj4mIzEwMDA2Ozwvc3Bhbj4nIDtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdGUgPT09ICdwZW5kaW5nJykge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiAnPHNwYW4gY2xhc3M9XCJwZW5kaW5nXCI+JiMxMDAwNDs8L3NwYW4+JyA7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXRlID09PSAnc2tpcHBlZCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxzcGFuIGNsYXNzPVwic2tpcHBlZFwiPiYjMTAwMzQ7PC9zcGFuPicgO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ3N1aXRlU3RhdGVDb2xvdXInLCBmdW5jdGlvbiAodGVzdHMsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgbGV0IG51bVRlc3RzID0gT2JqZWN0LmtleXModGVzdHMpLmxlbmd0aDtcclxuXHJcbiAgICAgICAgICAgICAgICBsZXQgZmFpbCA9IF8udmFsdWVzKHRlc3RzKS5maW5kKCh0ZXN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRlc3Quc3RhdGUgPT09ICdmYWlsZWQnO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIGlmIChmYWlsICE9IG51bGwpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3N1aXRlLWZhaWwnO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIGxldCBwYXNzZXMgPSBfLnZhbHVlcyh0ZXN0cykuZmlsdGVyKCh0ZXN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRlc3Quc3RhdGUgPT09ICdwYXNzZWQnO1xyXG4gICAgICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgICAgIGlmIChwYXNzZXMubGVuZ3RoID09PSBudW1UZXN0cyAmJiBudW1UZXN0cyA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gJ3N1aXRlLXBhc3MnO1xyXG4gICAgICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgICAgIC8vc2tpcHBlZCBpcyB0aGUgbG93ZXN0IHByaW9yaXR5IGNoZWNrXHJcbiAgICAgICAgICAgICAgICBsZXQgc2tpcHBlZCA9IF8udmFsdWVzKHRlc3RzKS5maW5kKCh0ZXN0KSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRlc3Quc3RhdGUgPT09ICdza2lwcGVkJztcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICBpZiAoc2tpcHBlZCAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdzdWl0ZS1wZW5kaW5nJztcclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICByZXR1cm4gJ3N1aXRlLXVua25vd24nXHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgSGFuZGxlYmFycy5yZWdpc3RlckhlbHBlcignaHVtYW5pemVEdXJhdGlvbicsIGZ1bmN0aW9uIChkdXJhdGlvbiwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbW9tZW50LmR1cmF0aW9uKGR1cmF0aW9uLCBcIm1pbGxpc2Vjb25kc1wiKS5mb3JtYXQoJ2hoOm1tOnNzLlNTJywge3RyaW06IGZhbHNlfSlcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZlN1aXRlSGFzVGVzdHMnLCBmdW5jdGlvbiAodGVzdHNIYXNoLCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChPYmplY3Qua2V5cyh0ZXN0c0hhc2gpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmZuKHRoaXMpXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmludmVyc2UodGhpcyk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuXHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2lmRXZlbnRJc0Vycm9yJywgZnVuY3Rpb24gKGV2ZW50LCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChldmVudC50eXBlLmluY2x1ZGVzKCdFcnJvcicpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5mbih0aGlzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuaW52ZXJzZSh0aGlzKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdpZkV2ZW50SXNTY3JlZW5zaG90JywgZnVuY3Rpb24gKGV2ZW50LCBoYm9wdHMpIHtcclxuICAgICAgICAgICAgICAgIGlmIChldmVudC50eXBlID09PSAnc2NyZWVuc2hvdCcpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGJvcHRzLmZuKHRoaXMpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5pbnZlcnNlKHRoaXMpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoJ2lmRXZlbnRJc0xvZ01lc3NhZ2UnLCBmdW5jdGlvbiAoZXZlbnQsIGhib3B0cykge1xyXG4gICAgICAgICAgICAgICAgaWYgKGV2ZW50LnR5cGUgPT09ICdsb2cnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGhib3B0cy5mbih0aGlzKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIHJldHVybiBoYm9wdHMuaW52ZXJzZSh0aGlzKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBIYW5kbGViYXJzLnJlZ2lzdGVySGVscGVyKCdsb2dDbGFzcycsIGZ1bmN0aW9uICh0ZXh0ICwgaGJvcHRzKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGV4dC5pbmNsdWRlcygnVGVzdCBJdGVyYXRpb24nKSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBcInRlc3QtaXRlcmF0aW9uXCI7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBcImxvZy1vdXRwdXRcIjtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgICAgICBPYmplY3Qua2V5cyhyZXBvcnRPcHRpb25zLnRlbXBsYXRlRnVuY3MpLmZvckVhY2goKGtleSk9PntcclxuICAgICAgICAgICAgICAgIEhhbmRsZWJhcnMucmVnaXN0ZXJIZWxwZXIoa2V5LCByZXBvcnRPcHRpb25zLnRlbXBsYXRlRnVuY3Nba2V5XSk7XHJcbiAgICAgICAgICAgIH0pO1xyXG5cclxuICAgICAgICAgICAgaWYgKGZzLnBhdGhFeGlzdHNTeW5jKHJlcG9ydE9wdGlvbnMub3V0cHV0RGlyKSkge1xyXG4gICAgICAgICAgICAgICBsZXQganNvbkZpbGUgPSByZXBvcnRPcHRpb25zLnJlcG9ydEZpbGUucmVwbGFjZSgnLmh0bWwnICwgJy5qc29uJykgO1xyXG4gICAgICAgICAgICAgICAgICAgIGZzLm91dHB1dEZpbGVTeW5jKGpzb25GaWxlLCBKU09OLnN0cmluZ2lmeShyZXBvcnRPcHRpb25zLmRhdGEpKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgbGV0IHRlbXBsYXRlID0gSGFuZGxlYmFycy5jb21waWxlKHRlbXBsYXRlRmlsZSk7XHJcbiAgICAgICAgICAgIGxldCBodG1sID0gdGVtcGxhdGUocmVwb3J0T3B0aW9ucy5kYXRhKTtcclxuXHJcbiAgICAgICAgICAgIGlmIChmcy5wYXRoRXhpc3RzU3luYyhyZXBvcnRPcHRpb25zLm91dHB1dERpcikpIHtcclxuICAgICAgICAgICAgICAgIGZzLm91dHB1dEZpbGVTeW5jKHJlcG9ydE9wdGlvbnMucmVwb3J0RmlsZSwgaHRtbCk7XHJcbiAgICAgICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgICAgIGlmIChyZXBvcnRPcHRpb25zLnNob3dJbkJyb3dzZXIpIHtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBjaGlsZFByb2Nlc3MgPSBvcGVuKHJlcG9ydE9wdGlvbnMucmVwb3J0RmlsZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkUHJvY2Vzcy50aGVuKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdicm93c2VyIGxhdW5jaGVkJyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKGVycm9yKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignc2hvd0luQnJvd3NlciBlcnJvciBzcGF3bmluZyA6JyArIHJlcG9ydE9wdGlvbnMucmVwb3J0RmlsZSArIFwiIFwiICsgZXJyb3IudG9TdHJpbmcoKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGV4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3Igb3BlbmluZyBicm93c2VyOicgKyBleCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKHJlcG9ydE9wdGlvbnMuTE9HKSB7XHJcbiAgICAgICAgICAgICAgICByZXBvcnRPcHRpb25zLkxPRy5kZWJ1ZyhcIkh0bWwgR2VuZXJhdGlvbiBjb21wbGV0ZWRcIik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgY2FsbGJhY2sodHJ1ZSk7XHJcbiAgICAgICAgfSBjYXRjaChleCkge1xyXG4gICAgICAgICAgICBpZiAocmVwb3J0T3B0aW9ucy5MT0cpIHtcclxuICAgICAgICAgICAgICAgIHJlcG9ydE9wdGlvbnMuTE9HLmVycm9yKFwiSHRtbCBHZW5lcmF0aW9uIHByb2Nlc3NpbmcgZW5kZWQgaW4gZXJyb3I6IFwiICsgZXgpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNhbGxiYWNrKGZhbHNlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCBkZWZhdWx0IEh0bWxHZW5lcmF0b3I7XHJcbiJdfQ==
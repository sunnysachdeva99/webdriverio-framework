"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _htmlGenerator = _interopRequireDefault(require("./htmlGenerator"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const fs = require('fs-extra');

const path = require('path');

const moment = require('moment');

const logger = require('@log4js-node/log4js-api');

function walk(dir, extensions, filelist = []) {
  const files = fs.readdirSync(dir);
  files.forEach(function (file) {
    const filepath = path.join(dir, file);
    const stat = fs.statSync(filepath);

    if (stat.isDirectory()) {
      filelist = walk(filepath, extensions, filelist);
    } else {
      extensions.forEach(function (extension) {
        if (file.indexOf(extension) == file.length - extension.length) {
          filelist.push(filepath);
        }
      });
    }
  });
  return filelist;
}

class ReportAggregator {
  constructor(opts) {
    opts = Object.assign({}, {
      outputDir: 'reports/html-reports/',
      filename: 'master-report.html',
      reportTitle: 'Test Master Report',
      showInBrowser: false,
      templateFilename: path.resolve(__dirname, '../templates/wdio-html-reporter-template.hbs'),
      templateFuncs: {},
      LOG: null
    }, opts);
    this.options = opts;

    if (!this.options.LOG) {
      this.options.LOG = logger.getLogger("default");
    }

    this.options.reportFile = path.join(process.cwd(), this.options.outputDir, this.options.filename);
    this.reports = [];
  }

  clean() {
    fs.emptyDirSync(this.options.outputDir);
  }

  readJsonFiles() {
    return walk(this.options.outputDir, [".json"]);
  }

  log(message, object) {
    if (this.options.LOG) {
      this.options.LOG.debug(message + object);
    }
  }

  async createReport(results) {
    let metrics = {
      passed: 0,
      skipped: 0,
      failed: 0,
      start: new moment(),
      end: new moment(),
      duration: 0
    };
    let suites = [];
    let specs = [];
    let files = this.readJsonFiles();

    for (let i = 0; i < files.length; i++) {
      try {
        let filename = files[i];
        let report = JSON.parse(fs.readFileSync(filename));

        if (!report.info || !report.info.specs) {
          this.options.LOG.error("report structure in question, no info or info.specs ", JSON.stringify(report));
          this.options.LOG.info("report content: ", JSON.stringify(report));
        }

        report.info.specs.forEach(spec => {
          specs.push(spec);
        });
        this.reports.push(report);
        metrics.passed += report.metrics.passed;
        metrics.failed += report.metrics.failed;
        metrics.skipped += report.metrics.skipped;

        for (let k = 0; k < report.suites.length; k++) {
          let suite = report.suites[k];
          let start = moment.utc(suite.start);

          if (start.isSameOrBefore(metrics.start)) {
            metrics.start = start;
          }

          let end = moment.utc(suite.end);

          if (end.isAfter(metrics.end)) {
            metrics.end = end;
          }

          suites.push(suite);
        }
      } catch (ex) {
        console.error(ex);
      }
    }

    if (!this.reports || !this.reports.length) {
      // the test failed hard at the beginning.  Create a dummy structure to get through html generation
      let report = {
        "info": {
          "cid": "The execution of the test suite has failed before report generation is started.  Please look at the logs to determine the error, this is likely an issue with your configuration files.",
          "config": {
            "hostname": "localhost"
          },
          "specs": [],
          "suites": [{
            "uid": "Test Start Failure",
            "title": "Test Start Failure",
            "type": "suite",
            "tests": []
          }]
        }
      };
      this.reports = [];
      this.reports.push(report);
    }

    let duration = metrics.end.diff(metrics.start);
    metrics.duration = moment.duration(duration, "milliseconds").format('hh:mm:ss.SS', {
      trim: false
    });
    metrics.start = metrics.start.format();
    metrics.end = metrics.end.format();
    const reportOptions = {
      data: {
        info: this.reports[0].info,
        specs: specs,
        metrics: metrics,
        suites: suites,
        title: this.options.reportTitle
      },
      outputDir: this.options.outputDir,
      reportFile: this.options.reportFile,
      templateFilename: this.options.templateFilename,
      LOG: this.options.LOG,
      templateFuncs: this.options.templateFuncs,
      showInBrowser: this.options.showInBrowser
    };

    _htmlGenerator.default.htmlOutput(reportOptions);
  }

}

var _default = ReportAggregator;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXBvcnRBZ2dyZWdhdG9yLmpzIl0sIm5hbWVzIjpbImZzIiwicmVxdWlyZSIsInBhdGgiLCJtb21lbnQiLCJsb2dnZXIiLCJ3YWxrIiwiZGlyIiwiZXh0ZW5zaW9ucyIsImZpbGVsaXN0IiwiZmlsZXMiLCJyZWFkZGlyU3luYyIsImZvckVhY2giLCJmaWxlIiwiZmlsZXBhdGgiLCJqb2luIiwic3RhdCIsInN0YXRTeW5jIiwiaXNEaXJlY3RvcnkiLCJleHRlbnNpb24iLCJpbmRleE9mIiwibGVuZ3RoIiwicHVzaCIsIlJlcG9ydEFnZ3JlZ2F0b3IiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJPYmplY3QiLCJhc3NpZ24iLCJvdXRwdXREaXIiLCJmaWxlbmFtZSIsInJlcG9ydFRpdGxlIiwic2hvd0luQnJvd3NlciIsInRlbXBsYXRlRmlsZW5hbWUiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwidGVtcGxhdGVGdW5jcyIsIkxPRyIsIm9wdGlvbnMiLCJnZXRMb2dnZXIiLCJyZXBvcnRGaWxlIiwicHJvY2VzcyIsImN3ZCIsInJlcG9ydHMiLCJjbGVhbiIsImVtcHR5RGlyU3luYyIsInJlYWRKc29uRmlsZXMiLCJsb2ciLCJtZXNzYWdlIiwib2JqZWN0IiwiZGVidWciLCJjcmVhdGVSZXBvcnQiLCJyZXN1bHRzIiwibWV0cmljcyIsInBhc3NlZCIsInNraXBwZWQiLCJmYWlsZWQiLCJzdGFydCIsImVuZCIsImR1cmF0aW9uIiwic3VpdGVzIiwic3BlY3MiLCJpIiwicmVwb3J0IiwiSlNPTiIsInBhcnNlIiwicmVhZEZpbGVTeW5jIiwiaW5mbyIsImVycm9yIiwic3RyaW5naWZ5Iiwic3BlYyIsImsiLCJzdWl0ZSIsInV0YyIsImlzU2FtZU9yQmVmb3JlIiwiaXNBZnRlciIsImV4IiwiY29uc29sZSIsImRpZmYiLCJmb3JtYXQiLCJ0cmltIiwicmVwb3J0T3B0aW9ucyIsImRhdGEiLCJ0aXRsZSIsIkh0bWxHZW5lcmF0b3IiLCJodG1sT3V0cHV0Il0s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QUFhLEdBQUc7QUFDbEJDLE1BQUFBLElBQUksRUFBRTtBQUNGZixRQUFBQSxJQUFJLEVBQUUsS0FBS3hCLE9BQUwsQ0FBYSxDQUFiLEVBQWdCd0IsSUFEcEI7QUFFRk4sUUFBQUEsS0FBSyxFQUFDQSxLQUZKO0FBR0ZSLFFBQUFBLE9BQU8sRUFBRUEsT0FIUDtBQUlGTyxRQUFBQSxNQUFNLEVBQUVBLE1BSk47QUFLRnVCLFFBQUFBLEtBQUssRUFBRSxLQUFLN0MsT0FBTCxDQUFhUDtBQUxsQixPQURZO0FBUWxCRixNQUFBQSxTQUFTLEVBQUUsS0FBS1MsT0FBTCxDQUFhVCxTQVJOO0FBU2xCVyxNQUFBQSxVQUFVLEVBQUUsS0FBS0YsT0FBTCxDQUFhRSxVQVRQO0FBVWxCUCxNQUFBQSxnQkFBZ0IsRUFBRSxLQUFLSyxPQUFMLENBQWFMLGdCQVZiO0FBV2xCSSxNQUFBQSxHQUFHLEVBQUcsS0FBS0MsT0FBTCxDQUFhRCxHQVhEO0FBWWxCRCxNQUFBQSxhQUFhLEVBQUUsS0FBS0UsT0FBTCxDQUFhRixhQVpWO0FBYWxCSixNQUFBQSxhQUFhLEVBQUUsS0FBS00sT0FBTCxDQUFhTjtBQWJWLEtBQXRCOztBQWdCQW9ELDJCQUFjQyxVQUFkLENBQXlCSixhQUF6QjtBQUVIOztBQXBJa0I7O2VBdUlKekQsZ0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgSHRtbEdlbmVyYXRvciBmcm9tIFwiLi9odG1sR2VuZXJhdG9yXCI7XHJcblxyXG5jb25zdCBmcyA9IHJlcXVpcmUoJ2ZzLWV4dHJhJyk7XHJcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XHJcbmNvbnN0IG1vbWVudCA9IHJlcXVpcmUoJ21vbWVudCcpO1xyXG5jb25zdCBsb2dnZXIgPSByZXF1aXJlKCdAbG9nNGpzLW5vZGUvbG9nNGpzLWFwaScpO1xyXG5cclxuZnVuY3Rpb24gIHdhbGsoZGlyLCBleHRlbnNpb25zICwgZmlsZWxpc3QgPSBbXSkge1xyXG4gICAgY29uc3QgZmlsZXMgPSBmcy5yZWFkZGlyU3luYyhkaXIpO1xyXG5cclxuICAgIGZpbGVzLmZvckVhY2goZnVuY3Rpb24gKGZpbGUpIHtcclxuICAgICAgICBjb25zdCBmaWxlcGF0aCA9IHBhdGguam9pbihkaXIsIGZpbGUpO1xyXG4gICAgICAgIGNvbnN0IHN0YXQgPSBmcy5zdGF0U3luYyhmaWxlcGF0aCk7XHJcblxyXG4gICAgICAgIGlmIChzdGF0LmlzRGlyZWN0b3J5KCkpIHtcclxuICAgICAgICAgICAgZmlsZWxpc3QgPSB3YWxrKGZpbGVwYXRoLCBleHRlbnNpb25zLCBmaWxlbGlzdCk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgZXh0ZW5zaW9ucy5mb3JFYWNoKGZ1bmN0aW9uIChleHRlbnNpb24pIHtcclxuICAgICAgICAgICAgICAgIGlmIChmaWxlLmluZGV4T2YoZXh0ZW5zaW9uKSA9PSBmaWxlLmxlbmd0aCAtIGV4dGVuc2lvbi5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICAgICAgICBmaWxlbGlzdC5wdXNoKGZpbGVwYXRoKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIGZpbGVsaXN0O1xyXG59XHJcblxyXG5jbGFzcyBSZXBvcnRBZ2dyZWdhdG9yIHtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihvcHRzKSB7XHJcbiAgICAgICAgb3B0cyA9IE9iamVjdC5hc3NpZ24oe30sIHtcclxuICAgICAgICAgICAgb3V0cHV0RGlyOiAncmVwb3J0cy9odG1sLXJlcG9ydHMvJyxcclxuICAgICAgICAgICAgZmlsZW5hbWU6ICdtYXN0ZXItcmVwb3J0Lmh0bWwnLFxyXG4gICAgICAgICAgICByZXBvcnRUaXRsZTogJ1Rlc3QgTWFzdGVyIFJlcG9ydCcsXHJcbiAgICAgICAgICAgIHNob3dJbkJyb3dzZXI6IGZhbHNlLFxyXG4gICAgICAgICAgICB0ZW1wbGF0ZUZpbGVuYW1lOiBwYXRoLnJlc29sdmUoX19kaXJuYW1lLCAnLi4vdGVtcGxhdGVzL3dkaW8taHRtbC1yZXBvcnRlci10ZW1wbGF0ZS5oYnMnKSxcclxuICAgICAgICAgICAgdGVtcGxhdGVGdW5jczoge30sXHJcbiAgICAgICAgICAgIExPRzogbnVsbFxyXG4gICAgICAgIH0sIG9wdHMpO1xyXG4gICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdHM7XHJcbiAgICAgICAgaWYgKCF0aGlzLm9wdGlvbnMuTE9HKSB7XHJcbiAgICAgICAgICAgIHRoaXMub3B0aW9ucy5MT0cgPSBsb2dnZXIuZ2V0TG9nZ2VyKFwiZGVmYXVsdFwiKSAgICAgIDtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5vcHRpb25zLnJlcG9ydEZpbGUgPSBwYXRoLmpvaW4ocHJvY2Vzcy5jd2QoKSwgdGhpcy5vcHRpb25zLm91dHB1dERpciwgdGhpcy5vcHRpb25zLmZpbGVuYW1lKTtcclxuICAgICAgICB0aGlzLnJlcG9ydHMgPSBbXTtcclxuICAgIH1cclxuXHJcbiAgICBjbGVhbigpIHtcclxuICAgICAgICBmcy5lbXB0eURpclN5bmModGhpcy5vcHRpb25zLm91dHB1dERpcik7XHJcbiAgICB9XHJcblxyXG5cclxuXHJcbiAgICByZWFkSnNvbkZpbGVzKCkge1xyXG4gICAgICAgIHJldHVybiB3YWxrKHRoaXMub3B0aW9ucy5vdXRwdXREaXIsIFtcIi5qc29uXCJdKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgbG9nKG1lc3NhZ2Usb2JqZWN0KSB7XHJcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5MT0cpIHtcclxuICAgICAgICAgICAgdGhpcy5vcHRpb25zLkxPRy5kZWJ1ZyhtZXNzYWdlICsgb2JqZWN0KSA7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG4gICAgYXN5bmMgY3JlYXRlUmVwb3J0KHJlc3VsdHMpIHtcclxuXHJcbiAgICAgICAgbGV0IG1ldHJpY3MgPSB7XHJcbiAgICAgICAgICAgIHBhc3NlZDogMCxcclxuICAgICAgICAgICAgc2tpcHBlZDogMCxcclxuICAgICAgICAgICAgZmFpbGVkOiAwLFxyXG4gICAgICAgICAgICBzdGFydCA6IG5ldyBtb21lbnQoKSxcclxuICAgICAgICAgICAgZW5kIDogbmV3IG1vbWVudCgpLFxyXG4gICAgICAgICAgICBkdXJhdGlvbjogMFxyXG4gICAgICAgIH07XHJcbiAgICAgICAgbGV0IHN1aXRlcyA9IFtdO1xyXG4gICAgICAgIGxldCBzcGVjcyA9IFtdO1xyXG5cclxuICAgICAgICBsZXQgZmlsZXMgPSB0aGlzLnJlYWRKc29uRmlsZXMoKTtcclxuXHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmaWxlcy5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgICAgICB0cnkge1xyXG4gICAgICAgICAgICAgICAgbGV0IGZpbGVuYW1lID0gZmlsZXNbaV07XHJcbiAgICAgICAgICAgICAgICBsZXQgcmVwb3J0ID0gSlNPTi5wYXJzZShmcy5yZWFkRmlsZVN5bmMoZmlsZW5hbWUpKTtcclxuICAgICAgICAgICAgICAgIGlmICghcmVwb3J0LmluZm8gfHwgIXJlcG9ydC5pbmZvLnNwZWNzKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5vcHRpb25zLkxPRy5lcnJvcihcInJlcG9ydCBzdHJ1Y3R1cmUgaW4gcXVlc3Rpb24sIG5vIGluZm8gb3IgaW5mby5zcGVjcyBcIiAsIEpTT04uc3RyaW5naWZ5KHJlcG9ydCkpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMub3B0aW9ucy5MT0cuaW5mbyhcInJlcG9ydCBjb250ZW50OiBcIiAsIEpTT04uc3RyaW5naWZ5KHJlcG9ydCkpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmVwb3J0LmluZm8uc3BlY3MuZm9yRWFjaCgoc3BlYykgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgIHNwZWNzLnB1c2goc3BlYykgO1xyXG4gICAgICAgICAgICAgICAgfSk7XHJcblxyXG5cclxuICAgICAgICAgICAgICAgIHRoaXMucmVwb3J0cy5wdXNoKHJlcG9ydCk7XHJcbiAgICAgICAgICAgICAgICBtZXRyaWNzLnBhc3NlZCArPSByZXBvcnQubWV0cmljcy5wYXNzZWQ7XHJcbiAgICAgICAgICAgICAgICBtZXRyaWNzLmZhaWxlZCArPSByZXBvcnQubWV0cmljcy5mYWlsZWQ7XHJcbiAgICAgICAgICAgICAgICBtZXRyaWNzLnNraXBwZWQgKz0gcmVwb3J0Lm1ldHJpY3Muc2tpcHBlZDtcclxuXHJcbiAgICAgICAgICAgICAgICBmb3IgKGxldCBrID0gMDsgayA8IHJlcG9ydC5zdWl0ZXMubGVuZ3RoOyBrKyspIHtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgc3VpdGUgPSByZXBvcnQuc3VpdGVzW2tdIDtcclxuICAgICAgICAgICAgICAgICAgICBsZXQgc3RhcnQgPSBtb21lbnQudXRjKHN1aXRlLnN0YXJ0KSA7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCBzdGFydC5pc1NhbWVPckJlZm9yZShtZXRyaWNzLnN0YXJ0KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtZXRyaWNzLnN0YXJ0ID0gIHN0YXJ0IDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGVuZCA9IG1vbWVudC51dGMoc3VpdGUuZW5kKSA7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKCBlbmQuaXNBZnRlcihtZXRyaWNzLmVuZCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWV0cmljcy5lbmQgPSAgZW5kIDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgc3VpdGVzLnB1c2goc3VpdGUpO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9IGNhdGNoIChleCkge1xyXG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihleCk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICghdGhpcy5yZXBvcnRzIHx8ICF0aGlzLnJlcG9ydHMubGVuZ3RoICkge1xyXG4gICAgICAgICAgICAvLyB0aGUgdGVzdCBmYWlsZWQgaGFyZCBhdCB0aGUgYmVnaW5uaW5nLiAgQ3JlYXRlIGEgZHVtbXkgc3RydWN0dXJlIHRvIGdldCB0aHJvdWdoIGh0bWwgZ2VuZXJhdGlvblxyXG4gICAgICAgICAgICBsZXQgcmVwb3J0ID0ge1xyXG4gICAgICAgICAgICAgICAgXCJpbmZvXCIgOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgXCJjaWRcIjogXCJUaGUgZXhlY3V0aW9uIG9mIHRoZSB0ZXN0IHN1aXRlIGhhcyBmYWlsZWQgYmVmb3JlIHJlcG9ydCBnZW5lcmF0aW9uIGlzIHN0YXJ0ZWQuICBQbGVhc2UgbG9vayBhdCB0aGUgbG9ncyB0byBkZXRlcm1pbmUgdGhlIGVycm9yLCB0aGlzIGlzIGxpa2VseSBhbiBpc3N1ZSB3aXRoIHlvdXIgY29uZmlndXJhdGlvbiBmaWxlcy5cIixcclxuICAgICAgICAgICAgICAgICAgICBcImNvbmZpZ1wiOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFwiaG9zdG5hbWVcIjogXCJsb2NhbGhvc3RcIlxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBcInNwZWNzXCI6IFtdLFxyXG4gICAgICAgICAgICAgICAgXCJzdWl0ZXNcIjogW1xyXG4gICAgICAgICAgICAgICAgICAgIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgXCJ1aWRcIjogXCJUZXN0IFN0YXJ0IEZhaWx1cmVcIixcclxuICAgICAgICAgICAgICAgICAgICAgICAgXCJ0aXRsZVwiOiBcIlRlc3QgU3RhcnQgRmFpbHVyZVwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBcInR5cGVcIjogXCJzdWl0ZVwiLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBcInRlc3RzXCI6IFtdLFxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBdXHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgIHRoaXMucmVwb3J0cyA9IFtdIDtcclxuICAgICAgICAgICAgdGhpcy5yZXBvcnRzLnB1c2gocmVwb3J0KTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGxldCBkdXJhdGlvbiA9IG1ldHJpY3MuZW5kLmRpZmYobWV0cmljcy5zdGFydCkgO1xyXG4gICAgICAgIG1ldHJpY3MuZHVyYXRpb24gPSBtb21lbnQuZHVyYXRpb24oZHVyYXRpb24sIFwibWlsbGlzZWNvbmRzXCIpLmZvcm1hdCgnaGg6bW06c3MuU1MnLCB7dHJpbTogZmFsc2V9KTtcclxuICAgICAgICBtZXRyaWNzLnN0YXJ0ID0gbWV0cmljcy5zdGFydC5mb3JtYXQoKSA7XHJcbiAgICAgICAgbWV0cmljcy5lbmQgPSBtZXRyaWNzLmVuZC5mb3JtYXQoKSA7XHJcblxyXG4gICAgICAgIGNvbnN0IHJlcG9ydE9wdGlvbnMgPSB7XHJcbiAgICAgICAgICAgIGRhdGE6IHtcclxuICAgICAgICAgICAgICAgIGluZm86IHRoaXMucmVwb3J0c1swXS5pbmZvLFxyXG4gICAgICAgICAgICAgICAgc3BlY3M6c3BlY3MsXHJcbiAgICAgICAgICAgICAgICBtZXRyaWNzOiBtZXRyaWNzLFxyXG4gICAgICAgICAgICAgICAgc3VpdGVzOiBzdWl0ZXMsXHJcbiAgICAgICAgICAgICAgICB0aXRsZTogdGhpcy5vcHRpb25zLnJlcG9ydFRpdGxlLFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBvdXRwdXREaXI6IHRoaXMub3B0aW9ucy5vdXRwdXREaXIsXHJcbiAgICAgICAgICAgIHJlcG9ydEZpbGU6IHRoaXMub3B0aW9ucy5yZXBvcnRGaWxlLFxyXG4gICAgICAgICAgICB0ZW1wbGF0ZUZpbGVuYW1lOiB0aGlzLm9wdGlvbnMudGVtcGxhdGVGaWxlbmFtZSxcclxuICAgICAgICAgICAgTE9HIDogdGhpcy5vcHRpb25zLkxPRyxcclxuICAgICAgICAgICAgdGVtcGxhdGVGdW5jczogdGhpcy5vcHRpb25zLnRlbXBsYXRlRnVuY3MsXHJcbiAgICAgICAgICAgIHNob3dJbkJyb3dzZXI6IHRoaXMub3B0aW9ucy5zaG93SW5Ccm93c2VyXHJcbiAgICAgICAgfTtcclxuXHJcbiAgICAgICAgSHRtbEdlbmVyYXRvci5odG1sT3V0cHV0KHJlcG9ydE9wdGlvbnMpO1xyXG5cclxuICAgIH1cclxufVxyXG5cclxuICAgIGV4cG9ydCBkZWZhdWx0IFJlcG9ydEFnZ3JlZ2F0b3I7XHJcbiJdfQ==